<script>
const URL_SHEET = "https://script.google.com/macros/s/AKfycbxaptskjOLWAyBeAFv5krO6m2VK7-GoKa0mvu28gvDuiy003wf_ylyVwM26IohZ_yBFWw/exec";

let registros = JSON.parse(localStorage.getItem("registrosTrator")) || [];
let filaSync = JSON.parse(localStorage.getItem("filaSync")) || [];

function salvarLocal() {
  localStorage.setItem("registrosTrator", JSON.stringify(registros));
}

function salvarFila() {
  localStorage.setItem("filaSync", JSON.stringify(filaSync));
}

function calcularHorasTrabalhadas(hIni, hFim) {
  let horas = hFim - hIni;
  return horas < 0 ? 0 : horas.toFixed(2);
}

function registrar() {
  const novoRegistro = {
    data: document.getElementById("data").value,
    operador: document.getElementById("operador").value.trim(),
    associado: document.getElementById("associado").value.trim(),
    modelo: document.getElementById("modelo").value.trim(),
    atividade: document.getElementById("atividade").value.trim(),
    horimetroInicial: parseFloat(document.getElementById("horimetroInicial").value),
    horimetroFinal: parseFloat(document.getElementById("horimetroFinal").value)
  };

  novoRegistro.horasTrabalhadas =
    calcularHorasTrabalhadas(novoRegistro.horimetroInicial, novoRegistro.horimetroFinal);

  registros.push(novoRegistro);
  filaSync.push(novoRegistro);

  salvarLocal();
  salvarFila();
  atualizarTabela();
  sincronizar();

  document.querySelectorAll("input").forEach(i => i.value = "");

  mostrarMensagem("Registro salvo localmente.", "sucesso");
}

async function sincronizar() {
  if (filaSync.length === 0) {
    console.log("Nada para sincronizar.");
    return;
  }

  try {
    for (let item of filaSync) {
      await fetch(URL_SHEET, {
        method: "POST",
        body: JSON.stringify(item),
        headers: { "Content-Type": "application/json" }
      });
    }

    filaSync = [];
    salvarFila();

    mostrarMensagem("Sincronizado com a planilha!", "sucesso");

  } catch (e) {
    mostrarMensagem("Sem internet. SerÃ¡ sincronizado depois.", "erro");
  }
}

function atualizarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";
  registros.forEach((r, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.data}</td>
      <td>${r.operador}</td>
      <td>${r.associado}</td>
      <td>${r.modelo}</td>
      <td>${r.atividade}</td>
      <td>${r.horimetroInicial}</td>
      <td>${r.horimetroFinal}</td>
      <td>${r.horasTrabalhadas}</td>
      <td><button onclick="apagarRegistro(${index})">Apagar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function apagarRegistro(id) {
  registros.splice(id, 1);
  salvarLocal();
  atualizarTabela();
}

function mostrarMensagem(texto, tipo) {
  const msg = document.getElementById("mensagem");
  msg.textContent = texto;
  msg.className = tipo;
  msg.style.display = "block";
}

atualizarTabela();
sincronizar();
</script>