<script>
let registros = JSON.parse(localStorage.getItem("registrosTrator")) || [];
let filaSync = JSON.parse(localStorage.getItem("filaSync")) || [];

// URL DO GOOGLE APPS SCRIPT (vamos criar depois)
const URL_SHEET = "https://script.google.com/macros/s/AKfycbxaptskjOLWAyBeAFv5krO6m2VK7-GoKa0mvu28gvDuiy003wf_ylyVwM26IohZ_yBFWw/exec";

function salvarLocal() {
  localStorage.setItem("registrosTrator", JSON.stringify(registros));
}

function salvarFilaSync() {
  localStorage.setItem("filaSync", JSON.stringify(filaSync));
}

function calcularHorasTrabalhadas(hIni, hFim) {
  let horas = hFim - hIni;
  return horas < 0 ? 0 : horas.toFixed(2);
}

function mostrarMensagem(texto, tipo) {
  const msg = document.getElementById("mensagem");
  msg.textContent = texto;
  msg.className = tipo;
  msg.style.display = "block";

  setTimeout(() => msg.style.display = "none", 3000);
}

// -------------------------
// 1️⃣ REGISTRAR
// -------------------------
function registrar() {
  const novoRegistro = {
    data: document.getElementById("data").value,
    operador: document.getElementById("operador").value.trim(),
    associado: document.getElementById("associado").value.trim(),
    modelo: document.getElementById("modelo").value.trim(),
    atividade: document.getElementById("atividade").value.trim(),
    horimetroInicial: parseFloat(document.getElementById("horimetroInicial").value),
    horimetroFinal: parseFloat(document.getElementById("horimetroFinal").value)
  };

  novoRegistro.horasTrabalhadas = calcularHorasTrabalhadas(
    novoRegistro.horimetroInicial,
    novoRegistro.horimetroFinal
  );

  registros.push(novoRegistro);
  filaSync.push(novoRegistro);

  salvarLocal();
  salvarFilaSync();
  atualizarTabela();

  document.querySelectorAll("input").forEach(i => i.value = "");
  mostrarMensagem("Registro salvo!", "sucesso");

  sincronizar(); // tenta enviar automaticamente
}

// -------------------------
// 2️⃣ ATUALIZAR TABELA
// -------------------------
function atualizarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";

  registros.forEach((r, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.data}</td>
      <td>${r.operador}</td>
      <td>${r.associado}</td>
      <td>${r.modelo}</td>
      <td>${r.atividade}</td>
      <td>${r.horimetroInicial}</td>
      <td>${r.horimetroFinal}</td>
      <td>${r.horasTrabalhadas}</td>
      <td><button class="btn-apagar" onclick="apagarRegistro(${index})">Apagar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// -------------------------
// 3️⃣ APAGAR REGISTRO
// -------------------------
function apagarRegistro(i) {
  registros.splice(i, 1);
  salvarLocal();
  atualizarTabela();
}

// -------------------------
// 4️⃣ SINCRONIZAR COM A PLANILHA
// -------------------------
async function sincronizar() {
  if (!URL_SHEET.startsWith("https://")) {
    mostrarMensagem("URL da planilha não configurada!", "erro");
    return;
  }

  if (filaSync.length === 0) {
    mostrarMensagem("Nada para sincronizar", "sucesso");
    return;
  }

  for (let item of filaSync) {
    try {
      await fetch(URL_SHEET, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(item)
      });
    } catch (e) {
      mostrarMensagem("Falha na sincronização. Tentando depois...", "erro");
      return;
    }
  }

  filaSync = [];
  salvarFilaSync();
  mostrarMensagem("Sincronizado com sucesso!", "sucesso");
}

// -------------------------
// 5️⃣ BOTÃO PARA APAGAR TUDO
// -------------------------
function limparTodos() {
  if (!confirm("Tem certeza que deseja apagar tudo?")) return;

  registros = [];
  filaSync = [];
  salvarLocal();
  salvarFilaSync();
  atualizarTabela();
}

atualizarTabela();
</script>
